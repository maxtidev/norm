<!DOCTYPE HTML>
<html lang="en-us" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using nimibook -->
        <meta charset="UTF-8">
        <title>Connection Pool - Norm</title>

        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Object-driven ORM for SQLite and Postgres">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üê≥</text></svg>">
        <link rel="stylesheet" href="./assets/css/variables.css">
        <link rel="stylesheet" href="./assets/css/general.css">
        <link rel="stylesheet" href="./assets/css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="./assets/FontAwesome/css/font-awesome.min.css">

        <!-- Highlight.js Stylesheets - I could use nimib native highlight but let's keep it for styling... -->
        <link rel="stylesheet" href="./assets/css/highlight.css">
        <link rel="stylesheet" href="./assets/css/tomorrow-night.css">
        <link rel="stylesheet" href="./assets/css/ayu-highlight.css">

        <!-- Custom theme stylesheets - why the "../"? -->


        

            <script src="https://cdn.jsdelivr.net/gh/pietroppeter/nimib@main/assets/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

        
        <!-- plausible analytics (new in nimibook) -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = ".//assets";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                                <ol class="chapter">
                <li class="chapter-item expanded ">
                  <a href="./index.html" tabindex="0">
                    <strong aria-hidden="true">1.</strong> Welcome to Norm!
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./models.html" tabindex="0">
                    <strong aria-hidden="true">2.</strong> Models 101
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./tutorial.html" tabindex="0">
                    <strong aria-hidden="true">3.</strong> Tutorial
                  </a></li>
                  <li>
                  <ol class="section">
                <li class="chapter-item expanded ">
                  <a href="./tutorial/tables.html" tabindex="0">
                    <strong aria-hidden="true">3.1.</strong> Tables
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./tutorial/rows.html" tabindex="0">
                    <strong aria-hidden="true">3.2.</strong> Rows
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./tutorial/rawSelects.html" tabindex="0">
                    <strong aria-hidden="true">3.3.</strong> Raw SQL interactions
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./tutorial/rowCaveats.html" tabindex="0">
                    <strong aria-hidden="true">3.4.</strong> Row Caveats
                  </a></li>
                  </ol>
                  </li>
                <li class="chapter-item expanded ">
                  <a href="./transactions.html" tabindex="0">
                    <strong aria-hidden="true">4.</strong> Transactions
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./indexes.html" tabindex="0">
                    <strong aria-hidden="true">5.</strong> Indexes
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./config.html" tabindex="0">
                    <strong aria-hidden="true">6.</strong> Configuration from Environment
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./pool.html" class="active" tabindex="0">
                    <strong aria-hidden="true">7.</strong> Connection Pool
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./fk.html" tabindex="0">
                    <strong aria-hidden="true">8.</strong> Manual Foreign Key Handling
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./customDatatypes.html" tabindex="0">
                    <strong aria-hidden="true">9.</strong> Custom Datatypes
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./fancy.html" tabindex="0">
                    <strong aria-hidden="true">10.</strong> Fancy Syntax
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./debug.html" tabindex="0">
                    <strong aria-hidden="true">11.</strong> Debugging SQL
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./changelog.html" tabindex="0">
                    <strong aria-hidden="true">12.</strong> Changelog
                  </a></li>
                </ol>
<!-- I could use also an unescaped context value -->
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Norm</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/moigagoo/norm" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1>Connection Pool</h1>
<p>Connection pooling is a technique that involves precreating and reusing a number of ever-open DB connections instead of opening connections on demand. Since opening and closing connections takes more time than passing open connections around, this technique is used to improve performance of web application under high load.</p>
<p>Norm offers a simple thread-safe connection pool implementation. It can be used with both Postgres and SQLite, and you even can create multiple pools if you need to.</p>
<p><strong>Important</strong> Connection pooling requires <code>--mm:orc</code>.</p>
<p>To use connection pool:</p>
<ol>
<li>create a <a href="/apidocs/norm/pool.html#Pool"><code>Pool</code></a> instance by calling <a href="/apidocs/norm/pool.html#newPool,Positive"><code>newPool</code></a></li>
<li>wrap your DB calls in a <a href="/apidocs/norm/pool.html#withDb.t,Pool,untyped"><code>withDb</code></a></li>
</ol>
<p><code>newPool</code> creates a pool of a given size with connections of type <code>DbConn</code> (either from <a href="/apidocs/norm/sqlite.html"><code>sqlite</code></a> or <a href="/apidocs/norm/postgres.html"><code>postgres</code></a>). The params for the connections are taken from the environment, similar to how <code>withDb</code> works (see <a href="/config.html">Configuration from Environment</a>).</p>
                        <pre><code class="nohighlight hljs nim"><span class="hljs-keyword">import</span> norm/[model, sqlite, pool]


<span class="hljs-keyword">type</span>
  <span class="hljs-type">Product</span> = <span class="hljs-keyword">ref</span> <span class="hljs-keyword">object</span> <span class="hljs-keyword">of</span> <span class="hljs-type">Model</span>
    name: <span class="hljs-built_in">string</span>
    price: <span class="hljs-built_in">float</span>

<span class="hljs-keyword">proc</span> newProduct(): <span class="hljs-type">Product</span> =
  <span class="hljs-type">Product</span>(name: <span class="hljs-string">&quot;&quot;</span>, price: <span class="hljs-number">0.0</span>)

putEnv(<span class="hljs-string">&quot;DB_HOST&quot;</span>, <span class="hljs-string">&quot;:memory:&quot;</span>)

<span class="hljs-keyword">var</span> connPool = newPool[<span class="hljs-type">DbConn</span>](<span class="hljs-number">10</span>)

withDb(connPool):
  db.createTables(newProduct())</code></pre><pre class="nb-output">CREATE TABLE IF NOT EXISTS &quot;Product&quot;(name TEXT NOT NULL, price FLOAT NOT NULL, id INTEGER NOT NULL PRIMARY KEY)</pre>
                        <h2>Pool Exhausted Policy</h2>
<p>If the app requests more connections from the pool than it can give, we say the pool is exhausted.</p>
<p>There are two ways a pool can react to that:</p>
<ol>
<li>raise a <a href="/apidocs/norm/pool.html#PoolExhaustedError"><code>PoolExhaustedError</code></a>; this is the default policy</li>
<li>open an additional connection and extend the pool size</li>
</ol>
<p>The policy is set during the pool creation by setting <code>poolExhaustedPolicy</code> param to either <code>pepRaise</code> or <code>pepExtend</code>.</p>
<p>To reset the pool back to its default size after it has been extended, call <a href="/apidocs/norm/pool.html#reset,Pool"><code>reset</code></a> proc on it.</p>
<h2>Manual Pool Manipulation</h2>
<p>You can borrow connections from the pool manually by calling <a href="/apidocs/norm/pool.html#add%2CPool%2CT"><code>pop</code></a> proc.</p>
<p><strong>Important</strong> If you choose to get connections from the pool manually, you must care about putting the borrowed connections back byb calling <a href="/apidocs/norm/pool.html#add,Pool,T"><code>add</code></a>.</p>
                        <pre><code class="nohighlight hljs nim"><span class="hljs-keyword">let</span> dbConn = connPool.pop()

<span class="hljs-keyword">var</span> product = newProduct()

product.name = <span class="hljs-string">&quot;Table&quot;</span>
product.price = <span class="hljs-number">123.45</span>

dbConn.insert(product)

connPool.add(dbConn)</code></pre><pre class="nb-output">INSERT INTO &quot;Product&quot; (name, price) VALUES(?, ?) &lt;- @['Table', 123.45]</pre>
                        <h2>Closing the Pool</h2>
<p>When you no longer need the pool, for example, when your app exits or crashes, to avoid leaving hanging connections, close the pool by calling <a href="/apidocs/norm/pool.html#close,Pool"><code>close</code></a>. This proc closes all connections in the pool and sets its size to 0.</p>
                        <pre><code class="nohighlight hljs nim">close connPool</code></pre>
                        <h2>Custom Connection Provider</h2>
<p>By default, new connections are added to the pool by calling <code>getDB</code>, which takes the DB params from the environment.</p>
<p>But you can override that. For example, to get one pool connected to one DB and another one connected to another one.</p>
<p>To do that, pass a function that returns <code>DbConn</code> to the Pool constructor:</p>
                        <pre><code class="nohighlight hljs nim"><span class="hljs-keyword">func</span> myDb: <span class="hljs-type">DbConn</span> = open(<span class="hljs-string">&quot;mydb.db&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)

<span class="hljs-keyword">var</span> anotherPool = newPool[<span class="hljs-type">DbConn</span>](<span class="hljs-number">10</span>, myDb)

<span class="hljs-keyword">assert</span> anotherPool.size == <span class="hljs-number">10</span>
<span class="hljs-keyword">assert</span> fileExists(<span class="hljs-string">&quot;mydb.db&quot;</span>)

close anotherPool
removeFile(<span class="hljs-string">&quot;mydb.db&quot;</span>)</code></pre>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="./config.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="./fk.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="./config.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="./fk.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>







        <script src="./assets/js/clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="./assets/js/book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
